// Copyright 2023 Google LLC.
// SPDX-License-Identifier: Apache-2.0
//
// Original source: https://github.com/getreuer/qmk-keymap
function u(a){null!=a.u&&(clearTimeout(a.u),a.u=null)}
function w(a,d,c){if(0!=d.g.length){u(a);a.l=!0;var b=a.j.currentTime+.02;a.h.gain.cancelScheduledValues(b);a.i.gain.cancelScheduledValues(b);a.o.frequency.cancelScheduledValues(b);a.i.gain.setValueAtTime(0,b);a.h.gain.linearRampToValueAtTime(0,b);a.h.gain.linearRampToValueAtTime(.25,b+.005);var f=[b],e=60/(64*a.v);for(let g=0;g<d.g.length;g++){const l=d.g[g].frequency,k=e*d.g[g].duration;a.i.gain.setValueAtTime(0,b);0<l&&(a.o.frequency.setValueAtTime(l,b),a.i.gain.linearRampToValueAtTime(1,b+x),
a.i.gain.setValueAtTime(1,b+k-y-A),a.i.gain.linearRampToValueAtTime(0,b+k-A));b+=k;f.push(b)}a.h.gain.setValueAtTime(0,b);var h=0;a.u=setInterval(()=>{const g=a.j.currentTime+.005;if(!(g<f[h])){for(;h<d.g.length&&g>=f[h+1];)h++;h<d.g.length?void 0!=c&&c(d.g[h]):(u(a),a.l=!1,void 0!=c&&c())}},15)}}function B(a){if(a.l){u(a);a.l=!1;var d=a.j.currentTime;a.h.gain.cancelScheduledValues(d);a.h.gain.setValueAtTime(a.h.gain.value,d+.02);a.h.gain.linearRampToValueAtTime(0,d+.1)}}
class C{constructor(){this.l=!1;this.v=D;this.j=new AudioContext;this.o=this.j.createOscillator();this.i=this.j.createGain();this.h=this.j.createGain();this.m=this.j.createBiquadFilter();this.u=null;this.o.type="square";this.o.connect(this.i);this.i.gain.value=0;this.i.connect(this.h);this.h.gain.value=0;this.h.connect(this.m);this.m.type="lowpass";this.m.frequency.value=2E3;this.m.Q.value=.7;this.m.connect(this.j.destination);this.o.start()}}var D=120,x=.003,y=.003,A=.0018;
function E(a,d){for(;d<a.length;d++)if(-1==" \t\n\\".indexOf(a.charAt(d)))return d;return a.length}
function F(a){if(4>a.length)throw Error("Song data is too short.");let d=[];for(var c=0;c<a.length;c++)d.push(a.charCodeAt(c));if(0<d[0])throw Error("Song has unsupported encoding.");a=G(d.slice(0,-2));if(d[d.length-2]!=a[0]||d[d.length-1]!=a[1])throw Error("Song has bad checksum.");a="";c=d[1];if(0<c){var b=d.slice(2,2+c);if(b.length>(6*H+7)/8)throw Error("Name is too long.");var f="";for(var e=0;e<b.length;e+=3){var h=Math.min(b.length-e,3);const l=3==h?4:h;let k=0;for(var g=0;g<h;g++)k|=b[e+g]<<
8*g;for(h=0;h<l;h++)g=k>>6*h&63,0<g&&(f+=I.charAt(g-1))}a+="#define "+f+" "}d=d.slice(2+c,-2);c=d.length/2;for(b=0;b<c;b++)f=J(d[2*b]),e=d[2*b+1],0<b&&(a+=", "),f=new L(f,e),0<f.frequency?(e=M(f.frequency),e=`_${N[e%12]}${Math.floor(e/12)}`):e="_REST",e=f.duration in O?`${O[f.duration]}_NOTE(${e})`:`M__NOTE(${e}, ${Math.round(f.duration)})`,a+=e;return a}
class P{constructor(a){this.g=[];this.duration=0;this.name="";let d=0;a=a.toUpperCase();var c=E(a,0);if("#DEFINE "===a.slice(c,c+8)){for(var b=c=E(a,c+8);b<a.length;b++){var f=a.charAt(b);if(-1!=" \t\n\\".indexOf(f))break;else{if(-1==I.indexOf(f))throw Error(`Invalid character in song name: "${a.slice(c,b+1)}"`);if(b-c>H)throw Error("Song name is too long.");}}if(b==c)throw Error("Error parsing song name.");this.name=a.slice(c,b);c=b}for(f=c;f<a.length;f++)if(b=a.charAt(f),"\\"!==b)if("("===b)d++;
else{if(")"===b)d--;else if(-1==Q.indexOf(b))throw Error(`Invalid character: '${b}'`);if(1<d)throw Error("')' expected.");if(0>d)throw Error("Unbalanced ( ).");if(0==d&&(","===b||f==a.length-1)){let g=","===b?f:f+1;for(c=E(a,c);g>c&&-1!=" \t\n\\".indexOf(a.charAt(g-1));)g--;if(g!=a.length||g!=c){b=a.slice(c,g);b=b.trim();if(!(12<=b.length&&18>=b.length)||"_NOTE("!==b.slice(2,8)||")"!==b.slice(-1)){a=20>=b.length?b:b.slice(0,18)+"...";c=b.indexOf(")");if(0<=c&&c<=b.length-2&&","!==b[c+1])throw Error(`',' expected: "${a}"`);
throw Error(`Invalid note: "${a}"`);}var e=b.slice(8,-1).split(","),h=void 0;if("M_"===b.slice(0,2)){if(2!=e.length)throw Error(`Invalid note: "${b}"`);h=parseFloat(e[1]);if(!(0<=h&&1E3>=h))throw Error(`Invalid duration: "${b}"`);}else{h=b.slice(0,2);if(!(h in R)||1!=e.length)throw Error(`Invalid note: "${b}"`);h=R[h]}b=e[0].trim();e=0;if("_REST"!==b){e=parseInt(b.slice(-1),10);const l=b.slice(1,-1);if(!(l in S&&"_"===b.charAt(0)&&0<=e&&8>=e))throw Error(`Invalid note: "${b}"`);e=J(12*e+S[l])}b=new L(e,
h);b.s={start:c,end:g};this.duration+=b.duration;this.g.push(b);c=f+1}}}if(0<d)throw Error("')' expected.");}}var I="0123456789_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",Q=I+" \t\n\\,()#",H=32;function M(a){return 0==a?108:Math.round(12*Math.LOG2E*Math.log(a/T))}function J(a){return 108<=a?0:T*Math.exp(a/(12*Math.LOG2E))}class L{constructor(a,d){this.s=null;this.frequency=a;this.duration=d}}
var T=16.35159783,R={B_:128,W_:64,H_:32,Q_:16,E_:8,S_:4,T_:2,BD:192,WD:96,HD:48,QD:24,ED:12,SD:6,TD:3},O={2:"T_",3:"TD",4:"S_",6:"SD",8:"E_",12:"ED",16:"Q_",24:"QD",32:"H_",48:"HD",64:"W_",96:"WD",128:"B_",192:"BD"},S={C:0,CS:1,DF:1,D:2,DS:3,EF:3,E:4,F:5,FS:6,GF:6,G:7,GS:8,AF:8,A:9,AS:10,BF:10,B:11},N="C CS D DS E F FS G GS A AS B".split(" ");function G(a){let d=1,c=0;for(let b=0;b<a.length;b++)d=(d+a[b])%255,c=(c+d)%255;return[d%255,c%255]};function U(a,d){const c=document.getElementById("toast"),b=document.getElementById("toast-icon"),f=document.getElementById("toast-message");null!=c&&null!=b&&null!=f&&(b.innerText=a,f.innerText=d,c.className="show",setTimeout(()=>{c.className=""},3E3))}
function V(){var a=window.location.href;if(navigator.clipboard)return navigator.clipboard.writeText(a);if(!window.getSelection)return Promise.resolve();var d=window.getSelection();if(null==d)return Promise.reject();const c=document.createElement("p");c.textContent=a;document.body.appendChild(c);a=document.createRange();a.setStartBefore(c);a.setEndAfter(c);d.removeAllRanges();d.addRange(a);d=document.execCommand("copy");document.body.removeChild(c);return d?Promise.resolve():Promise.reject()}
function W(){V().then(()=>U("share","URL copied to clipboard")).catch(()=>U("error","Please copy URL from location bar"))}
(function(){function a(m){c.value=m;try{k=new P(m),e.disabled=!1}catch(q){q instanceof Error&&(f.innerHTML=`<span class="code-error">${q.message}</span>`);k=null;e.disabled=!0;return}f.innerHTML=`Duration: ${(.0078125*k.duration).toFixed(1)} seconds<br>Firmware size: ${8*k.g.length} bytes`;m=(k.name?k.name+" \u2013 ":"")+"QMK song player \u266b";b.innerText=m;document.title=m;m=encodeURI;var X=btoa,r=k;let p=[];p.push(0);var n=r.name;if(n.length>H)throw Error("Name is too long.");let z=[];for(let q=
0;q<n.length;q+=4){var t=Math.min(n.length-q,4);const Y=4==t?3:t;let K=0;for(let v=0;v<t;v++)K|=I.indexOf(n.charAt(q+v))+1<<6*v;for(t=0;t<Y;t++)z.push(K>>8*t&255)}p.push(z.length);p.push(...z);for(n=0;n<r.g.length;n++)p.push(Math.min(Math.max(M(r.g[n].frequency),0),255)),p.push(Math.min(Math.max(Math.round(r.g[n].duration),0),255));p.push(...G(p));r="";for(n=0;n<p.length;n++)r+=String.fromCharCode(p[n]);window.history.replaceState("","",window.location.href.split("?")[0]+("?"+m(X(r))))}function d(){const m=
null!=l&&l.l;h.innerText=m?"stop":"play_arrow";(c.readOnly=m)||c.setSelectionRange(0,0)}const c=document.getElementById("song-code"),b=document.getElementById("song-title"),f=document.getElementById("song-info"),e=document.getElementById("play-button"),h=document.getElementById("play-button-icon");var g=document.getElementById("share-button");if(null!=c&&null!=b&&null!=f&&null!=e&&null!=h&&null!=g){var l=null,k=null;g.onclick=W;g=window.location.search;2<g.length?a(F(atob(decodeURI(g.slice(1))))):
a(c.value);c.oninput=()=>a(c.value);e.onclick=()=>{null==l&&(l=new C);l.l||null==k?B(l):w(l,k,m=>{c.focus();void 0==m?d():null!=m.s&&c.setSelectionRange(m.s.start,m.s.end)});d()}}})();
